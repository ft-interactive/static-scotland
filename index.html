<html>
<head>
	<title>static graphics with timestamps</title>
	<style type="text/css">
		@font-face{ 
			font-family: 'BentonSans';
			src: url('http://interactivegraphics.ft-static.com/inc/fonts/BentonSansLight.woff') format('woff'),
		}

		.render-canvas{
			display: none;
		}
	</style>
	<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> 
	<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/StackBlur.js"></script>
	<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script> 
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
<h1>Static poll graphics with timestamps.</h1>
</body>
<script type="text/javascript">
	var width = 600, height = 150,
	margin = { top:20, left:10,bottom:0,right:10}
	barHeight = 30,
	barYOffset = 60,
	backgroundBarColour = '#999',
	yesColour = '#009',
	noColour = '#900',
	ftPink = '#FFF0e1',
	logoFill = '#E4D7CC',
	tickOverlap = 5,
	subtitleOffset = 20,
	axisOffset = barYOffset - 10,
	axisColour = '#333',
	valueOffset = 20,
	timestampXOffset = -40,
	bigNumber = d3.format("0,000");

	d3.json('http://bertha.ig.ft.com/republish/publish/ig/0Ak6OnV5xs-BudHpMQU9ENlgzR1VNNDFBZk9iZFlpNnc/basic,fullresults',gotData);

	var date = new Date();
	var timestamp = d3.time.format("%H:%M - %B %d %Y")(date);
	var filetime = d3.time.format(" (%H%M - %B %d %Y)")(date);

	function gotData(data){
		var div = d3.select('body').selectAll('div')
			.data(data.fullresults.filter(function(d){ return (d.authoritylabel !== null); }))
			.enter().append('div');

		div.append('canvas').attr({
			'height':height,
			'width':width,
			'id':function(d){
				return 'render-canvas-' + d.code
			},
			'class':'render-canvas'
		})

		div.append('svg').attr({
						'width':width,
						'height':height,
						'id':function(d){
							return d.code;
						}
					}).call(resultBar);

		div.append('a').text( function(d){ return 'save ' + d.authoritylabel + filetime + '.png'; } ).attr({
			'href':function(d){
				var serializer = new XMLSerializer(),
			    SVGString = serializer.serializeToString(document.getElementById( d.code )),
				canvas = document.getElementById('render-canvas-'+d.code);
				canvg( canvas, SVGString );
				return canvas.toDataURL();
			},
			'id':function(d){ return 'button-' + d.code },
			'download':function(d){ return d.authoritylabel + filetime + '.png'} 
		});
	}

	function pct(d){
		return Math.round(d*1000)/10 + '%';
	}

	function resultBar(selection){
		//background
		selection.append('rect')
			.attr({	//overlapping the edge of thecanvas to avoid aliasing effect
				width:width + 10,
				height:height + 10,
				x:-5,
				y:-5,
				fill:ftPink
			})

		//scale
		var scale = d3.scale.linear()
			.domain( [0,1] )
			.range( [0, width - (margin.left + margin.right)] );

		//set up margins
		selection = selection.append('g').attr('transform','translate(' + margin.left + ',' + margin.top + ')');
		
		//title
		selection.append('text').text(function(d){
			return d.authoritylabel;
		});

		selection.append('text').text(function(d){
			return 'Turnout ' + pct(d.turnout) + ' (' + bigNumber(d.votestotal) + ' votes)';
		}).attr({
			'y':subtitleOffset
		});

		//subtitle
		//background rect
		selection.append('rect')
			.attr({
				'fill':backgroundBarColour,
				'stroke':'none',
				'width':scale(1),
				'height':barHeight,
				'y':barYOffset
			});

		//yes rect
		selection.append('rect')
			.attr({
				'fill':yesColour,
				'stroke':'none',
				'width':function(d){ return scale(d.pctyes); },
				'height':barHeight,
				'y':barYOffset
			});

		//no rect
		selection.append('rect')
			.attr({
				'fill':noColour,
				'stroke':'none',
				'width':function(d){ return scale(d.pctno); },
				'height':barHeight,
				'x':function(d){ return scale(1) - scale(d.pctno); },
				'y':barYOffset
			});

		//axis tics
		selection.append('line')
			.attr({
				x1:scale(0.5),
				y1:barYOffset -tickOverlap,
				x2:scale(0.5),
				y2:barYOffset + barHeight + tickOverlap,
				'stroke-width':2,
				'stroke':axisColour
			})
		//axis labels
		//YES
		selection.append('text')
			.text('YES')
			.attr({
				'y':axisOffset
			})
		//NO
		selection.append('text')
			.text('NO')
			.attr({
				'y':axisOffset,
				'text-anchor':'end',
				'x':scale(1)
			});
		
		//50%
		selection.append('text')
			.text('50%')
			.attr({
				'y':axisOffset,
				'text-anchor':'middle',
				'x':scale(0.5)
			});

		// yes value
		selection.append('text')
			.text(function(d){ return pct(d.pctyes)})
			.attr({
				'y':barYOffset + barHeight + valueOffset
			});

		// no value
		selection.append('text')
			.text(function(d){ return pct(d.pctno)})
			.attr({
				'y':barYOffset + barHeight + valueOffset,
				'text-anchor':'end',
				'x':scale(1)
			})

		//time stamp
		selection.append('text')
			.text(timestamp)
			.attr({
				'y':height - (margin.bottom + margin.top + 3), //a few extra pixels to give the descenders clearance
				'x':width - (margin.left + margin.right) + timestampXOffset,
				'text-anchor':'end'
			});

			//Logo watermark
		selection.append('g').attr({
			'transform':'translate(' + (width - 32) + ',' + (height - 32)  + ') scale(0.75, 0.75)'
		}).append('path')
			.attr({
				'fill':logoFill,
				'd':"M14.326,4.41754545 L15.0724,4.41754545 L14.9576,0.424 L0.1624,0.424 L0.1624,1.10922727 C0.6344,1.135 0.992,1.171 1.2344,1.21681818 C1.4768,1.26263636 1.6936,1.36368182 1.8852,1.52036364 C2.0768,1.67704545 2.204,1.89222727 2.268,2.16631818 C2.3316,2.44040909 2.3636,2.81881818 2.3636,3.30154545 L2.3636,15.6532273 C2.3636,16.1359545 2.3316,16.5110909 2.268,16.777 C2.204,17.0445455 2.0764,17.2601364 1.8852,17.416 C1.6936,17.5726818 1.4704,17.6774091 1.2152,17.7293636 C0.96,17.7817273 0.5964,17.8144545 0.124,17.8271364 L0.124,18.532 L8.5072,18.532 L8.5072,17.8271364 C7.92,17.8144545 7.48,17.7817273 7.1864,17.7293636 C6.8928,17.6774091 6.6376,17.5726818 6.4208,17.416 C6.204,17.2597273 6.0636,17.0445455 5.9996,16.777 C5.9356,16.5110909 5.904,16.1359545 5.904,15.6532273 L5.904,9.74145455 L7.2248,9.74145455 C8.4116,9.74145455 9.2792,9.92718182 9.8276,10.2994545 C10.3764,10.6709091 10.74,11.3725 10.9188,12.4038182 L11.5888,12.4038182 L11.5888,6.00277273 L10.9188,6.00277273 C10.804,6.66836364 10.6348,7.16459091 10.4116,7.49063636 C10.1884,7.81709091 9.8344,8.05190909 9.3492,8.1955 C8.8644,8.3395 8.1564,8.41109091 7.2248,8.41109091 L5.904,8.41109091 L5.904,2.67522727 C5.904,2.3095 5.968,2.06527273 6.0956,1.94131818 C6.2232,1.81695455 6.4848,1.75518182 6.8804,1.75518182 L9.56,1.75518182 C10.4404,1.75518182 11.1488,1.79445455 11.6848,1.87259091 C12.2208,1.95072727 12.664,2.10413636 13.0152,2.33281818 C13.366,2.56109091 13.6308,2.82863636 13.8092,3.13504545 C13.988,3.44186364 14.16,3.86936364 14.326,4.41754545 L14.326,4.41754545 L14.326,4.41754545 Z M31.1688,4.41754545 L32.0684,4.41754545 L31.7048,0.424 L16.1828,0.424 L15.8192,4.41754545 L16.7188,4.41754545 C16.9996,3.43859091 17.382,2.7505 17.8672,2.35204545 C18.352,1.954 19.06,1.75518182 19.992,1.75518182 L22.1736,1.75518182 L22.1736,15.6536364 C22.1736,16.1363636 22.142,16.5115 22.078,16.7774091 C22.0144,17.0449545 21.8772,17.2605455 21.6668,17.4164091 C21.4564,17.5730909 21.2104,17.6778182 20.9296,17.7297727 C20.6492,17.7821364 20.2344,17.8148636 19.686,17.8275455 L19.686,18.5324091 L28.2224,18.5324091 L28.2224,17.8275455 C27.6736,17.8148636 27.2556,17.7821364 26.9684,17.7297727 C26.6812,17.6778182 26.4324,17.5730909 26.222,17.4164091 C26.0116,17.2601364 25.8744,17.0449545 25.8108,16.7774091 C25.7472,16.5115 25.7152,16.1363636 25.7152,15.6536364 L25.7152,1.75518182 L27.8972,1.75518182 C28.8284,1.75518182 29.5368,1.954 30.0216,2.35204545 C30.5056,2.75009091 30.8884,3.43859091 31.1688,4.41754545 L31.1688,4.41754545 L31.1688,4.41754545 Z"
			});
	}

</script>
</html>